<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Editor Markdown con GitHub</title>
<link rel="stylesheet" href="editor.css">
<link rel="stylesheet" href="editorOriginal.css">

  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/editor.md@1.5.0/editormd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/editor.md@1.5.0/languages/en.js"></script>
</head>
<body>

<div id="configurator">
  <h3>Configura Editor Markdown</h3>
  <input type="text" id="username" placeholder="GitHub Username" />
  <input type="text" id="repo" placeholder="Repository Name" />
  <input type="password" id="token" placeholder="Personal Access Token" />
  <button id="startBtn" class="action-btn">Avvia Editor</button>
</div>
<button id="sidebar-toggle">☰</button>
<div id="sidebar">
  <h3>File disponibili:</h3>

    <button id="refreshRepoBtn" class="sidebar-btn">Aggiorna repo</button>
  <ul id="file-list-ul"></ul>
    <button id="newFileBtn" class="sidebar-btn">Nuovo file Markdown</button>
    <button id="saveBtn" class="sidebar-btn">Salva Modifiche</button>
    <button id="deployBtn" class="sidebar-btn">Esegui Deploy Docs</button>
    <button id="deleteFileBtn" class="sidebar-btn delete-btn">Elimina file</button>
  <div id="uploadBox" class="upload-box">
    <label class="upload-label">Carica Immagine:</label><br>
    <input type="file" id="uploadImage" accept="image/*" class="upload-input" />
    <button id="uploadBtn" class="sidebar-btn">Carica Immagine</button>
    <button id="showImagesBtn" class="sidebar-btn">Vedi Immagini</button>
    <button id="deleteImageBtn" class="sidebar-btn delete-btn">Elimina immagine</button>
<!-- Modale elimina immagine -->
<div id="deleteImageModal" class="modal-bg">
    <div class="modal-box delete-modal">
        <button id="closeDeleteImageModal" class="modal-close delete-close">&times;</button>
        <h3>Elimina immagine</h3>
        <div id="deleteImageList" class="modal-list"></div>
        <button id="confirmDeleteImageBtn" class="modal-btn delete-btn">Conferma eliminazione</button>
    </div>
</div>
  </div>
</div>
<!-- Modale elimina file -->
<div id="deleteFileModal" class="modal-bg">
  <div class="modal-box delete-modal">
    <button id="closeDeleteFileModal" class="modal-close delete-close">&times;</button>
    <h3>Elimina file Markdown</h3>
    <div id="deleteFileList" class="modal-list"></div>
    <button id="confirmDeleteFileBtn" class="modal-btn delete-btn">Conferma eliminazione</button>
  </div>
</div>

<!-- Modale avviso modifiche non salvate -->
<div id="unsavedChangesModal" class="modal-bg">
  <div class="modal-box unsaved-modal">
    <h3 class="modal-title">Attenzione</h3>
    <p>Salvare prima di cambiare file.<br>Le modifiche non salvate andranno perse.</p>
    <div class="modal-actions">
      <button id="closeUnsavedModalBtn" class="modal-btn">Chiudi</button>
      <button id="confirmOpenFileBtn" class="modal-btn">Apri nuovo file</button>
    </div>
  </div>
</div>
<div id="imagesModal" class="modal-bg">
  <div class="modal-box images-modal">
    <button id="closeImagesModal" class="modal-close">&times;</button>
    <h3>Immagini disponibili</h3>
    <div id="imagesList"></div>
  </div>
</div>

<div id="editor" class="wising-section">
  <textarea style="display:none;"># Benvenuto nel tuo editor Markdown</textarea>
</div>



<script>
/* ================== VARIABILI GLOBALI ================== */
let editor, currentFileContent = null;
let currentFilePath = null, currentSha = null;
let currentUsername = null, currentRepo = null, currentToken = null;
let branch = "main";
let cachedImages = [], lastLoadedFiles = [];
let pendingOpenFile = null, selectedFileToDelete = null, selectedImageToDelete = null;

/* ================== FUNZIONI UTILI ================== */
function decodeBase64Utf8(base64Str) {
  const binary = atob(base64Str.replace(/\s/g, ""));
  return new TextDecoder("utf-8").decode(Uint8Array.from(binary, c => c.charCodeAt(0)));
}
function encodeUtf8Base64(str) {
  return btoa(unescape(encodeURIComponent(str)));
}
function hasUnsavedChanges() {
  return editor && currentFileContent !== null && editor.getMarkdown() !== currentFileContent;
}

/* ================== EDITOR ================== */
function initEditor() {
  editor = editormd("editor", {
    width: "100%",
    height: 640,
    path: "https://cdn.jsdelivr.net/npm/editor.md@1.5.0/lib/",
    toolbar: true,
    imageUpload: false,
    htmlDecode: true,
    setMarkdown: "# Benvenuto nel tuo editor Markdown",
    onload: updatePreviewImages,
    onchange: updatePreviewImages
  });
}
function updatePreviewImages() {
  setTimeout(() => {
    $(".editormd-preview-container img").each(function() {
      const src = $(this).attr("src");
      const found = cachedImages.find(img => src === img.local || src.endsWith("/" + img.name));
      if (found?.dataUrl) $(this).attr("src", found.dataUrl);
    });
  }, 300);
}

/* ================== GESTIONE FILE ================== */
function loadFiles(username, repo, token) {
  $("#file-list-ul").empty();
  lastLoadedFiles = [];

  function fetchFolder(path = "") {
    $.ajax({
      url: `https://api.github.com/repos/${username}/${repo}/contents/${path}`,
      headers: { Authorization: `token ${token}` },
      success: files => {
        files.forEach(file => {
          if (file.type === "dir" && (file.path === "documentation" || file.path.startsWith("documentation/"))) {
            fetchFolder(file.path);
          } else if (file.type === "file" && file.name.endsWith(".md") && !file.path.startsWith("documentation/site/")) {
            if (path.startsWith("documentation")) {
              $("#file-list-ul").append(`<li><a href="#" class="open-md-file" data-path="${file.path}">${file.path}</a></li>`);
              lastLoadedFiles.push(file.path);
            }
          }
        });
      },
      error: err => console.error("Errore caricamento file:", err)
    });
  }
  fetchFolder();
}
function loadFile(path, username, repo, token) {
  $.ajax({
    url: `https://api.github.com/repos/${username}/${repo}/contents/${path}?ref=${branch}`,
    headers: { Authorization: `token ${token}` },
    success: file => {
      if (!file?.content) return;
      const content = decodeBase64Utf8(file.content);
      currentFileContent = content;
      editor.setMarkdown(content);
      currentFilePath = path; currentSha = file.sha;
      currentUsername = username; currentRepo = repo; currentToken = token;
      loadImagesList(updatePreviewImages);
      setTimeout(() => {
        const baseUrl = `https://raw.githubusercontent.com/${username}/${repo}/${branch}/documentation/docs/`;
        $(".editormd-preview-container img").each(function() {
          const src = $(this).attr("src");
          if (src?.startsWith("images/")) $(this).attr("src", baseUrl + src.replace(/^\/+/, ""));
        });
      }, 500);
    },
    error: err => alert("Errore nel caricamento del file.")
  });
}
function saveFile() {
  if (!currentFilePath || !currentUsername || !currentRepo || !currentToken) {
    alert("Nessun file selezionato o credenziali mancanti.");
    return;
  }
  let content = editor.getMarkdown();
  content = content.replace(/!\[(.*?)\]\(https:\/\/raw\.githubusercontent\.com\/[^\/]+\/[^\/]+\/[^\/]+\/documentation\/docs\/images\/([^\)]+)\)/g, "![$1](images/$2)");
  $.ajax({
    url: `https://api.github.com/repos/${currentUsername}/${currentRepo}/contents/${currentFilePath}`,
    type: "PUT",
    headers: { Authorization: `token ${currentToken}` },
    data: JSON.stringify({ message: "Aggiornamento file da editor web", content: encodeUtf8Base64(content), sha: currentSha }),
    success: res => { alert("File salvato!"); currentSha = res.content.sha; },
    error: err => alert("Errore nel salvataggio del file.")
  });
}

/* ================== GESTIONE IMMAGINI ================== */
function loadImagesList(callback) {
  $.ajax({
    url: `https://api.github.com/repos/${currentUsername}/${currentRepo}/contents/documentation/docs/images/media`,
    headers: { Authorization: `token ${currentToken}` },
    success: files => {
      cachedImages = files.filter(f => f.type === "file").map(f => ({
        name: f.name, local: "images/media/" + f.name, download_url: f.download_url, dataUrl: null
      }));
      let pending = cachedImages.length;
      cachedImages.forEach((img, idx) => {
        $.ajax({
          url: img.download_url, xhrFields: { responseType: "blob" },
          success: blob => {
            const reader = new FileReader();
            reader.onloadend = () => {
              cachedImages[idx].dataUrl = reader.result;
              if (--pending === 0 && callback) callback(cachedImages);
            };
            reader.readAsDataURL(blob);
          },
          error: () => { if (--pending === 0 && callback) callback(cachedImages); }
        });
      });
    },
    error: () => { cachedImages = []; if (callback) callback([]); }
  });
}
function uploadImage(file) {
  const reader = new FileReader();
  reader.onload = e => {
    const base64 = e.target.result.split(",")[1];
    $.ajax({
      url: `https://api.github.com/repos/${currentUsername}/${currentRepo}/contents/documentation/docs/images/media/${file.name}`,
      type: "PUT",
      headers: { Authorization: `token ${currentToken}` },
      data: JSON.stringify({ message: "Aggiunta immagine da editor web", content: base64 }),
      success: () => alert("Immagine caricata!"),
      error: () => alert("Errore nel caricamento immagine.")
    });
  };
  reader.readAsDataURL(file);
}

/* ================== DEPLOY ================== */
function editAutomationYaml(setTrue, callback) {
  const url = `https://api.github.com/repos/${currentUsername}/${currentRepo}/contents/.github/workflows/Automation.yml`;
  $.ajax({
    url, headers: { Authorization: `token ${currentToken}` },
    success: file => {
      let content = decodeBase64Utf8(file.content)
        .replace(/RUN_DEPLOY_DOCS: '(true|false)'/, `RUN_DEPLOY_DOCS: '${setTrue}'`);
      $.ajax({
        url, type: "PUT", headers: { Authorization: `token ${currentToken}` },
        data: JSON.stringify({ message: setTrue ? "Abilita deploy docs" : "Disabilita deploy docs", content: encodeUtf8Base64(content), sha: file.sha }),
        success: res => callback?.(res.content.sha),
        error: () => alert("Errore nel salvataggio di Automation.yml.")
      });
    },
    error: () => alert("Errore nel caricamento di Automation.yml.")
  });
}

/* ================== STATO REPO ================== */
function updateRepoStatusBox(state, msg) {
  const indicator = $("#repo-status-indicator"), text = $("#repo-status-text");
  if (state === "updating") indicator.css("background", "#fd6c35"), text.html("Stato repository: <b>In aggiornamento...</b>");
  else if (state === "ok") indicator.css("background", "#16c784"), text.html("Stato repository: <b>Aggiornata</b>");
  else indicator.css("background", "#ccc"), text.html("Stato repository: <b>?</b>");
  if (msg) text.append("<br><small>" + msg + "</small>");
}
function checkRepoStatus() {
  if (!currentUsername || !currentRepo || !currentToken) return updateRepoStatusBox("unknown");
  $.ajax({
    url: `https://api.github.com/repos/${currentUsername}/${currentRepo}/commits?per_page=1`,
    headers: { Authorization: `token ${currentToken}` },
    success: commits => {
      if (commits?.length) {
        const lastDate = new Date(commits[0].commit.committer.date);
        const diff = (new Date() - lastDate) / 1000;
        updateRepoStatusBox(diff < 30 ? "updating" : "ok", "Ultima modifica: " + lastDate.toLocaleTimeString());
      }
    },
    error: () => updateRepoStatusBox("unknown")
  });
}
setInterval(checkRepoStatus, 5000);

/* ================== EVENTI ================== */
$(document).on("click", ".open-md-file", function(e) {
  e.preventDefault();
  const path = $(this).data("path");
  if (hasUnsavedChanges()) {
    pendingOpenFile = { path, username: currentUsername, repo: currentRepo, token: currentToken };
    $("#unsavedChangesModal").show();
  } else {
    loadFile(path, currentUsername, currentRepo, currentToken);
  }
});
$("#confirmOpenFileBtn").on("click", () => { if (pendingOpenFile) { loadFile(pendingOpenFile.path, pendingOpenFile.username, pendingOpenFile.repo, pendingOpenFile.token); pendingOpenFile = null; $("#unsavedChangesModal").hide(); }});
$("#saveBtn").on("click", saveFile);
$("#uploadBtn").on("click", () => { const file = $("#uploadImage")[0].files[0]; if (file) uploadImage(file); });
$("#deployBtn").on("click", () => { editAutomationYaml(true, () => setTimeout(() => editAutomationYaml(false), 5000)); });
$("#startBtn").on("click", () => {
  currentUsername = $("#username").val(); currentRepo = $("#repo").val(); currentToken = $("#token").val();
  if (!currentUsername || !currentRepo || !currentToken) return alert("Compila tutti i campi!");
  $("#configurator").hide(); $("#editor,#file-list").show(); initEditor(); loadFiles(currentUsername, currentRepo, currentToken);
});
$("#sidebar-toggle").on("click", function() {
  $("#sidebar").toggleClass("collapsed");
  if($("#sidebar").hasClass("collapsed")) {
    $("#sidebar").css("left", "-280px");
    $("#editor").css("margin-left", "0");
  } else {
    $("#sidebar").css("left", "0");
    $("#editor").css("margin-left", "280px");
  }
});
// Mostra modale elimina immagine
$("#deleteImageBtn").on("click", function() {
  loadImagesList(function(files) {
    if (!files || files.length === 0) {
      alert("Nessuna immagine disponibile da eliminare.");
      return;
    }
    let html = '<ul class="delete-image-list">';
    files.forEach(f => {
      html += `<li class='delete-image-item'><label><input type='radio' name='deleteImageRadio' value='${f.local}' class='delete-image-radio'>${f.local}</label></li>`;
    });
    html += '</ul>';
    $("#deleteImageList").html(html);
    window.selectedImageToDelete = null;
    $("#deleteImageModal").css("display", "block");
  });
});
// Chiudi modale elimina immagine
$("#closeDeleteImageModal").on("click", function() {
  $("#deleteImageModal").css("display", "none");
});
// Mostra modale immagini come accordion
$("#showImagesBtn").on("click", function() {
  loadImagesList(function(files) {
    let html = '<div id="images-accordion">';
    files.forEach((f, idx) => {
      html += `
        <div class="img-accordion">
          <span class="img-title" data-idx="${idx}" style="cursor:pointer;">${f.name}</span>
          <button class="img-btn copy-img-name" data-name="${f.name}" title="Copia nome">📋</button>
        </div>
        <div class="img-panel" style="display:none;">
          <img src='${f.dataUrl || f.download_url}' alt='${f.name}' class="img-preview-large">
        </div>
      `;
    });
    html += '</div>';
    $("#imagesList").html(html);
    $("#imagesModal").css("display", "block");
  });
});
// Toggle accordion
$(document).on("click", ".img-title", function() {
  $(this).closest('.img-accordion').next('.img-panel').slideToggle(180);
});
// Copia nome immagine
$(document).on("click", ".copy-img-name", function() {
  const name = $(this).data("name");
  navigator.clipboard.writeText(name);
  $(this).text('✔️');
  setTimeout(() => $(this).text('📋'), 900);
});
// Chiudi modale immagini
$("#closeImagesModal").on("click", function() {
  $("#imagesModal").css("display", "none");
});
// Chiudi modale unsaved changes
$("#closeUnsavedModalBtn").on("click", function() {
  $("#unsavedChangesModal").css("display", "none");
});
</script>

</body>
</html>